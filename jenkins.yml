pipeline {
  environment {
     
    REPO_NAME = "webapp"
    
    registry = "shubhamkawane0502/${REPO_NAME}"
     
    registryCredential = 'docker_hub_user'   //dockerhub_cred
    registry_url = "https://registry-1.docker.io/"
    
    GIT_HASH = '';
  }
  agent any
  stages {
    stage('Cloning Git Repo') {
      steps {
        git branch: 'main',credentialsId: 'github_token', url: "https://github.com/CSYE7125AdvanceCloud-ShubhamDarpit/${REPO_NAME}.git"
      }
    }
    stage('Maven Build Package') {
      steps {
        script {
          sh(script: "mvn clean install -DskipTests=true");
        }
      }
    }
    stage('Building Docker image') {
      steps{
          sh 'ls -al'
        script {
         GIT_HASH = sh(script: "git rev-parse HEAD", returnStdout: true).trim();
          sh(script: "docker build . -t ${REPO_NAME}");
        }
      }
    }
    stage('Deploy Image') {
      steps{
        script {
        withCredentials([usernamePassword( credentialsId: 'docker_hub_user', usernameVariable: 'USER', passwordVariable: 'PASSWORD')]) {
                withDockerRegistry([ credentialsId: "docker_hub_user", url: "${registry_url}" ]){  
                        sh(script: "docker login -u $USER -p $PASSWORD")
                        sh(script: "docker tag ${REPO_NAME} ${registry}:${GIT_HASH}")
                        sh(script: "docker push ${registry}:${GIT_HASH}") 
                }
                
            }
        }
      }
    }
  }
}
